# Takes a directory of logfiles generated by Lua's optim.logger, in the form:
# 
# MeanF1:{cpu=false,datafile="opp1.dat",seed=123,rundir="exp",learningRate=0.0001,maxInNorm=3,batchSize=64,layerSize=512,minEpoch=30,gpu=1,patience=10,momentum=0.9,numLayers=1,dropout=0.5,learningRateDecay=0.0005,maxEpoch=150,logdir="exp"}  epoch number	
# 6.6587e-03	 1.0000e+00	
# 6.6587e-03	 2.0000e+00	
# 6.6587e-03	 3.0000e+00	
# 6.6587e-03	 4.0000e+00	
# 6.6587e-03	 5.0000e+00	
#
# Then, a table is generated in R, for subsequent analysis:
#
# print(resultsTable)
# lastF1Score           usedCPU          datafile 
# "0.049258"           "false"    "\"opp1.dat\"" 
# randomSeed            rundir      learningRate 
# "123"         "\"exp\""          "0.0001" 
# maxInNorm         batchSize         layerSize 
# "3"              "64"             "512" 
# minEpoch      whichGPUused          patience 
# "30"               "1"              "10" 
# momentum         numLayers           dropout 
# "0.9"               "1"             "0.5" 
# learningRateDecay          maxEpoch            logdir 
# "0.0005"             "150"        "\"exp\"}" 

afterEquals<-function(stringToSplit){
  strsplit( stringToSplit, split="=",fixed=TRUE)[[1]][2]
  #stringToSplit.substr(stringToSplit.indexOf("=") + 1)
}

parseFile <-function(fileURI){
    title.line <- scan(fileURI,what='character',n = 1) 
    file1 = read.delim(fileURI)
   epochPerformanceValues = as.vector(file1)[1]
   lastPerformanceValue = tail(epochPerformanceValues[[1]] ,n=1)
   hyperparameters_list = unlist( lapply(X = strsplit(title.line,',',fixed=TRUE)[[1]], FUN = afterEquals) )
   #c(lastPerformanceValue[1])
   c(lastPerformanceValue, hyperparameters_list)
}

directory_with_log_files = '/Users/shanework/Desktop/fakelogs'
setwd(directory_with_log_files)
file_list <- list.files(directory_with_log_files)


for (file in file_list){
  
  #if merged dataset doesn't exist:
  if (!exists("resultsTable")){
    resultsTable <- parseFile(file)
  }
  
  #if merged dataset exists:
  else if(exists("resultsTable")){
    new_row <- parseFile(file)
    resultsTable<-rbind(resultsTable, new_row)
    rm(new_row)
  }
  
  #print(parseFile(file))
}
print(resultsTable)

names(resultsTable) = c('lastF1Score', 'usedCPU', 'datafile', 'randomSeed', 'rundir', 'learningRate', 'maxInNorm', 'batchSize', 'layerSize', 'minEpoch', 'whichGPUused', 'patience', 'momentum', 'numLayers', 'dropout', 'learningRateDecay','maxEpoch', 'logdir')
